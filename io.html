<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>I/O - The Noise Book</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="noise.html">noise</a></li><li><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li><a href="setup.html"><strong aria-hidden="true">1.1.</strong> Setup</a></li></ol></li><li><a href="nodes.html"><strong aria-hidden="true">2.</strong> Nodes</a></li><li><ol class="section"><li><a href="messages.html"><strong aria-hidden="true">2.1.</strong> Messages</a></li><li><a href="identities.html"><strong aria-hidden="true">2.2.</strong> Identities</a></li><li><a href="transports.html"><strong aria-hidden="true">2.3.</strong> Transports</a></li><li><a href="nat.html"><strong aria-hidden="true">2.4.</strong> NAT Traversal</a></li></ol></li><li><a href="peers.html"><strong aria-hidden="true">3.</strong> Peers</a></li><li><ol class="section"><li><a href="io.html" class="active"><strong aria-hidden="true">3.1.</strong> I/O</a></li></ol></li><li><a href="protocol.html"><strong aria-hidden="true">4.</strong> Protocol</a></li><li><ol class="section"><li><a href="ecdh.html"><strong aria-hidden="true">4.1.</strong> Elliptic Curve Diffie-Hellman Handshake (ECDH)</a></li><li><a href="aead.html"><strong aria-hidden="true">4.2.</strong> Authenticated Encryption w/ Authenticated Data (AEAD)</a></li><li><a href="skademlia.html"><strong aria-hidden="true">4.3.</strong> S/Kademlia</a></li></ol></li><li><a href="callbacks.html"><strong aria-hidden="true">5.</strong> Callbacks</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">The Noise Book</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#io" id="io"><h1>I/O</h1></a>
<p>After having established a connection with a peer and registering a couple of <code>noise.Message</code> types, you are now ready to start sending and receiving some messages via Noise.</p>
<p>Noise was designed with the intent of making message I/O be as simple as possible. More specifically, writing message sending/receiving code should <em>look</em> and <em>feel</em> synchronous when in reality Noise handles all of the asynchronous/concurrent work for you.</p>
<p>For a bit of background, from the very moment a peer is successfully dialed, or a peer connects to your node, two goroutines are spawned.</p>
<p>A send worker is spawned responsible for linearizing and send messages over the wire.</p>
<p>A receive worker is spawned responsible for deciphering the contents of raw network packets into <code>noise.Opcode</code> and <code>noise.Message</code> instances that may be intercepted.</p>
<a class="header" href="#sending-a-message" id="sending-a-message"><h2>Sending a message</h2></a>
<p>In order to send a message, you would instantiate a message you wish to send over the wire and use either of the following methods:</p>
<pre><code class="language-go">var peer *noise.Peer
var msg noise.Message

// Send a message, and block the current goroutine until the message is successfully sent.
err := peer.SendMessage(msg)
if err != nil {
    panic(&quot;failed to send message&quot;)
}

// Send a message and create a channel which may be read for broadcasting errors at a later time.
err := &lt;-peer.SendMessageAsync(msg)
if err != nil {
    panic(&quot;failed to send message&quot;)
}
</code></pre>
<p><code>SendMessage(noise.Message) error</code> sends a message whose type is registered with Noise to a specified peer. Calling this function will block the current goroutine until the message is successfully sent.</p>
<p>On the other hand, using <code>SendMessageAsync(noise.Message) &lt;-chan error</code> will not block the current goroutine, and instead simply queues the message up and lets you read from the channel for broadcasting errors anytime throughout your p2p application.</p>
<p>Both methods above are guaranteed to block until your message to be sent gets successfully queued into the send worker.</p>
<p>It is guaranteed that by sending message through either of the means above, all messages are sent in a linearized order.</p>
<p>All functions will return errors if:</p>
<ol>
<li>it takes too long to send a message,</li>
<li>the message requested to be sent is not actually registered to Noise,</li>
<li>or the send worker responsible for linearizing the order of sent messages is too busy for too long of a period of time.</li>
</ol>
<p>It is guaranteed that <code>SendMessageAsync</code> will at most only emit one error; you may choose to directly <code>close()</code> the channel after receiving a single message should you rather not have Go's garbage collector manually close the channel for you.</p>
<p>To figure out how to adjust the timeouts which define how long is 'too long' as to when a message is considered to have failed to be delivered, check out the <code>Messages</code> section in <code>Nodes</code>.</p>
<a class="header" href="#receiving-a-message" id="receiving-a-message"><h2>Receiving a message</h2></a>
<p>In order to receive a message, you would specify the opcode of the message you expect to receive from a given peer like so:</p>
<pre><code class="language-go">import &quot;time&quot;

var peer *noise.Peer
var someMessagesOpcode noise.Opcode

// Receive an expected message, but panic should we be waiting for the message for
// too long.
select {
    case expectedMessage := &lt;-peer.Receive(someMessagesOpcode):
        fmt.Println(&quot;Got the message we were looking for:&quot;, expectedMessage)
    case &lt;-time.After(3 * time.Second):
        panic(&quot;We waited for 3 seconds and still didn't get the message we wanted :(&quot;)
}
</code></pre>
<p><code>Receive(noise.Opcode) &lt;-chan noise.Message</code> was intentionally designed to return a channel that may be read from multiple times to allow for complete flexibility on how messages should be received from a peer.</p>
<p>You may timeout the receiving of a message should we be waiting for a message from a peer for too long, or create an infinite loop acting as an event loop that expects, receives, and processes multiple messages designated by their opcodes at once.</p>
<pre><code class="language-go">import &quot;github.com/perlin-network/noise&quot;
import &quot;time&quot;

var peer *noise.Peer
var opcode1, opcode2, opcode3 noise.Opcode

// An example of an infinite loop that awaits and handles messages from a designated
// peer.
func receiveWorkerLoop(peer *noise.Peer, kill &lt;-chan struct{}) {
    for {
        select {
        case &lt;-kill:
            return
        case msg := &lt;-peer.Receive(opcode1):
            // handle opcode 1 here...
        case msg := &lt;-peer.Receive(opcode2):
            // handle opcode 2 here...
        case msg := &lt;-peer.Receive(opcode3):
            // handle opcode 3 here...
        default:
            // maybe do something else if we did not receive a message?
        }
    }
}

func main() {
    var node *noise.Node
    
    // ...
    // ... setup node here
    // ...
    
    // Have the receive worker loop run in a new goroutine on every single
    // newly connected/dialed peer.
    node.OnPeerInit(func(node *noise.Node, peer *noise.Peer) error {
        kill := make(chan struct{})
        go receiveWorkerLoop(peer, kill)
        
        // Maybe after 5 seconds, kill the receive worker loop?
        go func() {
            &lt;-time.After(5 * time.Seconds)
            
            close(kill)
        }()
        
        return nil
    })
}
</code></pre>
<a class="header" href="#atomic-operations" id="atomic-operations"><h2>Atomic Operations</h2></a>
<p>One important feature Noise provides is being able to perform atomic operations over the network upon the recipient of a message.</p>
<p>Examples of such atomic operations include blocking the recipient of any messages from a designated peer except for a specific message.</p>
<p>This is is extremely useful for establishing synchronization points/acknowledgements between peers that from both sides, which allow us to know that they both completed some sort of action such as completing some handshake protocol scheme at the same time.</p>
<pre><code class="language-go">import &quot;time&quot;

var peer *noise.Peer
var opcodeACK noise.Opcode

type ACK struct { noise.Message }

noise.RegisterMessage(noise.NextAvailableOpcode(), (*ACK)(nil))

// Send an ACK message to establish a synchronization point.
err := peer.SendMessage(ACK{})
if err != nil {
    panic(&quot;failed to send ACK to peer&quot;)
}

// Upon the recipient of an ACK message, block the recipient of any
// other messages from this peer until `Unlock()` gets called.
locker := peer.LockOnReceive(b.opcodeACK)
defer locker.Unlock()

select {
    case &lt;-time.After(3 * time.Second):
        return errors.Wrap(protocol.DisconnectPeer, &quot;timed out waiting for AEAD ACK&quot;)
    case &lt;-peer.Receive(b.opcodeACK):
}

// We have entered the 'critical section' of our protocol that is safely executed
// by our node and our peer. We can do stuff like setup encryption/decryption
// schemes where we encrypt every message we send, and decrypt every message
// we receive from now on.
//
// It is guaranteed that within this critical section, we will NOT receive
// or handle any other messages.

peer.BeforeMessageReceived(func(node *noise.Node, peer *noise.Peer, msg []byte) (buf []byte, err error) {
    // ... do decryption here.
    return msg, nil
})

peer.BeforeMessageSent(func(node *noise.Node, peer *noise.Peer, msg []byte) (buf []byte, err error) {
    // ... do encryption here.
    return msg, nil
})

// Do whatever else you want here until `locker.Unlock()` gets called.
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="peers.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="protocol.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="peers.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="protocol.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
