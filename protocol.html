<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Protocol - The Noise Book</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body class="light">
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = default_theme; }
            document.body.className = theme;
            document.querySelector('html').className = theme + ' js';
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="noise.html">noise</a></li><li><a href="intro.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li><ol class="section"><li><a href="setup.html"><strong aria-hidden="true">1.1.</strong> Setup</a></li></ol></li><li><a href="nodes.html"><strong aria-hidden="true">2.</strong> Nodes</a></li><li><ol class="section"><li><a href="messages.html"><strong aria-hidden="true">2.1.</strong> Messages</a></li><li><a href="identities.html"><strong aria-hidden="true">2.2.</strong> Identities</a></li><li><a href="transports.html"><strong aria-hidden="true">2.3.</strong> Transports</a></li><li><a href="nat.html"><strong aria-hidden="true">2.4.</strong> NAT Traversal</a></li></ol></li><li><a href="peers.html"><strong aria-hidden="true">3.</strong> Peers</a></li><li><ol class="section"><li><a href="io.html"><strong aria-hidden="true">3.1.</strong> I/O</a></li></ol></li><li><a href="protocol.html" class="active"><strong aria-hidden="true">4.</strong> Protocol</a></li><li><ol class="section"><li><a href="ecdh.html"><strong aria-hidden="true">4.1.</strong> Elliptic Curve Diffie-Hellman Handshake (ECDH)</a></li><li><a href="aead.html"><strong aria-hidden="true">4.2.</strong> Authenticated Encryption w/ Authenticated Data (AEAD)</a></li><li><a href="skademlia.html"><strong aria-hidden="true">4.3.</strong> S/Kademlia</a></li></ol></li><li><a href="callbacks.html"><strong aria-hidden="true">5.</strong> Callbacks</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">The Noise Book</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                            
                        </div>
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="#protocol" id="protocol"><h1>Protocol</h1></a>
<p>Now that we have gone over the concepts of nodes and peers, you know how to setup node identities, listen for/connect to peers, send messages to/receive messages from peers, deal with message serialization/deserialization, and a lot more through Noise.</p>
<p>On a high level, <strong>noise</strong> comes with a <code>protocol</code> package that builds on top of a variety of node/peer events to allow you to easily compose your p2p applications networking protocol out of composable <code>protocol.Block</code>'s.</p>
<pre><code class="language-go">package protocol

import &quot;github.com/perlin-network/noise&quot;

type Block interface {
    OnRegister(p *Protocol, node *noise.Node)
    OnBegin(p *Protocol, peer *noise.Peer) error
    OnEnd(p *Protocol, peer *noise.Peer) error
}
</code></pre>
<p>A <code>protocol.Block</code> represents a implementation of a modular, well-defined sub-protocol defined by 3 events: <code>OnRegister</code>, <code>OnBegin</code>, and <code>OnEnd</code>.</p>
<p>When a block gets registered into a protocol, <code>OnRegister</code> gets called. Typically, you would define variables, register opcodes, register callback functions to your <code>*noise.Node</code>, or register <code>noise.Message</code>'s inside <code>OnRegister</code>.</p>
<p><code>OnBegin</code> gets called when a peer has completed executing all other prior blocks. You would define the core block logic inside <code>OnBegin</code> you would expect a peer to follow, or set custom metadata to a peer, or even spawn infinite-loop receive workers to handle messages from peers here.</p>
<p><code>OnEnd</code> gets called when a peer disconnects, in the case that you wish to clean up any particular tracked data of a peer should they depart from your network.</p>
<p>For both <code>OnBegin</code> and <code>OnEnd</code>, you can return a <code>protocol.DisconnectPeer</code> error at any time which will directly halt execution of the protocols logic and disconnect the peer from your node should they misbehave/error out in any way.</p>
<p>Returning any other sort of error otherwise would directly log the error onto your console as a warning.</p>
<p>Returning nil in <code>OnBegin</code> would have peers transition into the next block within the protocol.</p>
<p>When a peer runs out of blocks to execute, they remain dormant for the time being.</p>
<a class="header" href="#composition" id="composition"><h2>Composition</h2></a>
<p>Your p2p application would compose together these blocks in an order you may choose to allow you to easily build a custom, secure, and performant networking protocol.</p>
<p>On a high level, examples of what a <code>protocol.Block</code> may represent are:</p>
<ol>
<li>a handshake protocol section,</li>
<li>a session establishment protocol section,</li>
<li>a message broadcasting protocol section,</li>
<li>or an overlay network section.</li>
</ol>
<p>Noise provides a number of high-level, well-tested basic protocol building blocks any p2p application would need to help you kickstart building your p2p application.</p>
<p>After picking a few blocks, or even implementing your own <code>protocol.Block</code>'s, you may then define your protocol like so:</p>
<pre><code class="language-go">import (
    &quot;github.com/perlin-network/noise/protocol&quot;
    &quot;github.com/perlin-network/noise/handshake/ecdh&quot;
    &quot;github.com/perlin-network/noise/cipher/aead&quot;
    &quot;github.com/perlin-network/noise/skademlia&quot;
)

policy := protocol.New()

// First, all nodes must perform an Elliptic-Curve Diffie-Hellman (ECDH) handshake
// between each other to establish a shared symmetric encryption key.
policy.Register(ecdh.New())

// The shared key from ECDH then gets derived by a HMAC to establish a new encrypted
// session where all communication between a pair of nodes is then encrypted using
// Authenticated Encryption w/ Authenticated Data (AEAD) via AES-256 GCM.
policy.Register(aead.New())

// After all communication has been readily encrypted, perform a S/Kademlia handshake
// to exchange S/Kademlia node IDs, setup a S/Kademlia routing table, and start
// handling S/Kademlia-related overlay network RPC messages.
policy.Register(skademlia.New())
</code></pre>
<p>The order in which you register the blocks as you may be able to tell matters, as <code>protocol</code> for the time being linearly traverses through all blocks in the order they are registered.</p>
<p>After registering the ordering in which you expect peers to execute blocks, you may then enforce your custom networking protocol on multiple <code>*noise.Node</code> instances at once like so:</p>
<pre><code class="language-go">import &quot;github.com/perlin-network/noise&quot;

var node1, node2 *noise.Node

// Enforce both node1 and node2 to follow your custom policy
// when it comes to dealing with peers.
policy.Enforce(node1)
policy.Enforce(node2)
</code></pre>
<p>All peers which connect to either <code>node1</code> or <code>node2</code> from then on will follow your policy, and be disconnected from you should they fail to otherwise.</p>
<p>Typically, you would define and enforce your protocol on your node before you start listening for peers and start dialing/connecting to other peers.</p>
<blockquote>
<p><strong>Note:</strong> All protocol logic is handled in a separate goroutine from where nodes/peers are instantiated, so it is safe to execute blocking code inside a block so long as you intend to block a peer from progressing further from within a protocol until some condition is met.</p>
</blockquote>
<a class="header" href="#helpers" id="helpers"><h2>Helpers</h2></a>
<p>A set of helper functions are provided in the <code>protocol</code> package to help you manage a small set of well-defined metadata we at Perlin found to be common-place in all kinds of networking protocools.</p>
<p>Shared keys, node IDs, peer IDs, and mapping peer IDs to <code>*noise.Peer</code> instances are what we provide off-the-shelf.</p>
<p>We additionally provide a standardized interface for defining what an ID should comprise of:</p>
<pre><code class="language-go">package protocol

import &quot;github.com/perlin-network/noise&quot;
import &quot;fmt&quot;

type ID interface {
    fmt.Stringer
    noise.Message

    Equals(other ID) bool

    PublicKey() []byte
    Hash() []byte
}


func HasSharedKey(peer *noise.Peer) bool { ... }
func LoadSharedKey(peer *noise.Peer) []byte { ... }
func MustSharedKey(peer *noise.Peer) []byte { ... } 
func SetSharedKey(peer *noise.Peer, sharedKey []byte) { ... }
func DeleteSharedKey(peer *noise.Peer) { ... }

func SetNodeID(node *noise.Node, id ID) { ... }
func DeleteNodeID(node *noise.Node) { ... }
func HasPeerID(peer *noise.Peer) bool { ... }
func SetPeerID(peer *noise.Peer, id ID) { ... }
func DeletePeerID(peer *noise.Peer) { ... }

func NodeID(node *noise.Node) ID { ... }
func PeerID(peer *noise.Peer) ID { ... }
func Peer(node *noise.Node, id ID) *noise.Peer { ... }
</code></pre>
<p>If you would like suggest any other type of metadata you think is common-place within a large variety of networking protocols that could be managed from within the <code>protocol</code> package, feel free to post up a Github issue.</p>
<p>For the next couple of pages, we'll go over a couple of high-level protocol blocks which Noise provides from the get-go.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="io.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="ecdh.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="io.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="ecdh.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        

    </body>
</html>
